# コスト最適化戦略

## 概要

HackStoryは1000ユーザーで月額$10以下での運用を目標としています。このドキュメントでは、コスト削減のための設計と実装方針を説明します。

## コスト予算設定

### GCP予算アラート

- **月額予算上限**: $20
- **アラート閾値**: 50%, 80%, 100%
- **通知先**: メール、Slack（設定可能）

### リソース制限設計

#### Cloud Run（フロントエンド）
- **CPU**: 1コア
- **メモリ**: 512MB
- **最大インスタンス数**: 10（初期は5）
- **最小インスタンス数**: 0（コスト削減）
- **リクエストタイムアウト**: 60秒

#### Cloud Run（バックエンド）
- **CPU**: 1コア
- **メモリ**: 1GB
- **最大インスタンス数**: 10（初期は5）
- **最小インスタンス数**: 0（コスト削減）
- **リクエストタイムアウト**: 60秒

#### スケーリング設定
- **CPU使用率**: 60%でスケールアウト
- **同時リクエスト数**: 80
- **コールドスタート許容**: 最小インスタンス0によりコスト削減

## キャッシング戦略

### フロントエンド

1. **静的JSONファイル配信**
   - ストーリーコンテンツ: `frontend/public/stories/` に配置
   - Cloud Storage不要（コスト削減）
   - Next.jsの静的配信機能を活用

2. **SSG/ISRの活用**
   - ストーリー一覧: SSG（Static Site Generation）
   - チャレンジ一覧: SSG
   - ダッシュボード: ISR（Incremental Static Regeneration）

### バックエンド

1. **インメモリキャッシュ**
   - Redis不使用（コスト削減）
   - ASP.NET Core MemoryCacheを活用
   - キャッシュ有効期限:
     - ストーリーメタデータ: 1時間
     - チャレンジ一覧: 1時間
     - チャレンジ詳細: 30分
     - ユーザー進捗: 5分
     - 統計情報: 5分

2. **HTTPキャッシュヘッダー**
   - Cache-Controlヘッダーの適切な設定
   - ETagの活用
   - 304 Not Modifiedの返却

## API呼び出しの削減

### フロントエンド側の最適化

1. **デバウンス処理**
   - 進捗保存: 500msデバウンス
   - 検索機能: 300msデバウンス

2. **バッチ処理**
   - 複数の進捗更新をまとめて送信
   - バッチサイズ: 10件

3. **クライアントサイド処理**
   - ストーリー分岐ロジック: クライアントサイドで実行
   - チャレンジ検証: 可能な限りクライアントサイドで実行

### バックエンド側の最適化

1. **レート制限**
   - 認証API: 5回/分/IP
   - チャレンジ提出: 10回/分/ユーザー
   - ヒント取得: 3回/分/ユーザー

2. **リクエストサイズ制限**
   - 最大リクエストボディ: 1MB
   - 最大URL長: 2048文字

## データベース最適化

### CockroachDB Serverless

1. **無料枠の活用**
   - 50M RU/月（無料）
   - 10GBストレージ（無料）

2. **クエリ最適化**
   - 必要なカラムのみ取得（SELECT * を避ける）
   - 適切なインデックスの設定
   - バッチ処理の活用

3. **接続プール**
   - 最大接続数: 10
   - 接続タイムアウト: 30秒

## モニタリング設計

### Cloud Monitoringダッシュボード

監視項目:
- Cloud Runのリクエスト数
- Cloud RunのCPU/メモリ使用率
- Cloud Runのレスポンス時間
- CockroachDBのクエリ数
- CockroachDBのRU使用量
- コスト推移グラフ

### アラート設定

1. **コスト関連**
   - 予算の50%到達時
   - 予算の80%到達時
   - 予算の100%到達時

2. **パフォーマンス関連**
   - リクエスト数が異常に増加（1時間で10,000リクエスト以上）
   - レスポンス時間が3秒を超える
   - CPU使用率が90%を超える

3. **可用性関連**
   - エラー率が5%を超える
   - データベース接続エラー

## コスト見積もり（1000ユーザー）

### 前提条件
- 登録ユーザー: 1,000人
- アクティブユーザー率: 30% → 300人/月
- アクセス頻度: 8回/月/人
- 1セッションあたりのAPI呼び出し: 20回

### 使用量
- 月間APIリクエスト数: 48,000リクエスト（無料枠200万内）
- 月間CPU時間: 4,800 vCPU秒（無料枠180,000秒内）
- 月間メモリ時間: 4,800 GiB秒（無料枠360,000 GiB秒内）

### 月額コスト
- **Cloud Run**: $0（無料枠内）
- **CockroachDB Serverless**: $0（無料枠内）
- **その他**: $0-5/月
- **合計**: **$0-10/月**

## 実装チェックリスト

- [ ] GCP予算アラートの設定
- [ ] Cloud Runリソース制限の設定
- [ ] インメモリキャッシュの実装
- [ ] HTTPキャッシュヘッダーの設定
- [ ] デバウンス・バッチ処理の実装
- [ ] レート制限の実装
- [ ] Cloud Monitoringダッシュボードの作成
- [ ] アラート設定の実装

